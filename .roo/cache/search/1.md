## CACHE METADATA
- ID: 1
- Created: 2026-02-06T19:06:20.149Z
- Git Commit: d183d9e45dafb516c7c800f1490a98c4ee517b02
- TTL: 168 hours

## QUERY
Where is the wiki indexer or term parsing logic implemented in the v2 and v3 reference code?

## SCOPE
- Directories: e:/_Project/xlxz-wiki/refernece/v2,e:/_Project/xlxz-wiki/refernece/v3
- File Patterns: *.ts,*.js
- Excludes: node_modules,*.lock,dist,.cache,.temp

## SCHEMA
```json
{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"summary":{"type":"string"}}}
```

## RESULT

## Wiki Indexer 和 Term Parsing 逻辑实现位置调查

### 核心发现

Wiki indexer 和 term parsing 逻辑在 v2 和 v3 中都实现在 **`.vuepress/`** 目录下，采用模块化架构。

### 完整文件清单

**v2 实现** (`refernece/v2/data/docs/.vuepress/`)：
- `indexer.ts` - Wiki 索引构建核心类
- `utils/termParsing.ts` - 词条引用解析工具
- `utils/definitionParsing.ts` - 定义内容解析（支持嵌套词条）
- `utils/formulaUtils.ts` - 公式提取和渲染工具
- `utils/idUtils.ts` - ID 生成和路径处理
- `utils/markdownUtils.ts` - Markdown 围栏/代码块处理
- `types.ts` - 数据结构定义
- `config.ts` - 配置
- `plugins/wiki-plugin.ts` - VuePress 插件入口

**v3 实现** (`refernece/v3/data/docs/.vuepress/`)：
- `indexer.ts` - Wiki 索引构建核心类（优化版本）
- `utils/termParsing.ts` - 词条引用解析工具（保持不变）
- `utils/definitionParsing.ts` - 定义内容解析（支持嵌套词条）
- `utils/formulaUtils.ts` - 公式提取和渲染工具（精简版本）
- `utils/idUtils.ts` - ID 生成和路径处理（精简版本）
- `utils/markdownUtils.ts` - Markdown 处理工具（保持不变）
- `types.ts` - 数据结构定义（扩展版本）
- `config.ts` - 配置
- `plugins/wiki-plugin.ts` - VuePress 插件入口

### 核心逻辑架构

```
WikiIndexer (indexer.ts)
├── buildIndex()
│   ├── getMarkdownFiles() - 递归扫描 .md 文件
│   ├── parseFile() - 解析单个文件
│   │   ├── parseTerms() - 【术语】：定义 格式
│   │   ├── parseFormulas() - %% 公式 %% 格式
│   │   └── parseTemplates() - {占位符} 模板格式
│   └── saveIndex() - 保存为 JSON 和 ESM 模块
│
├── 词条解析 (termParsing.ts)
│   ├── parseTermReference() - 解析 scope/term 格式
│   └── calculateSimilarity() - 编辑距离相似度计算
│
├── 定义渲染 (definitionParsing.ts)
│   ├── parseDefinitionParts() - 支持嵌套【词条】
│   ├── applyBasicMarkdown() - 轻量 Markdown 处理
│   └── buildDefinitionHtml() - 生成交互式 HTML
│
└── 工具类
    ├── formulaUtils.ts - [计算值] <设计值> 提取
    ├── idUtils.ts - 内容哈希 ID 生成
    └── markdownUtils.ts - 围栏代码块状态管理
```

### v2 → v3 的关键改进

**1. 索引构建优化（indexer.ts）**
- v2: 基础实现，读取最新文件内容
- v3: 添加版本戳和随机哈希确保 HMR 触发，详细日志记录

**2. 词条定义策略变化（parseTerms）**
- v2: 使用前 3 行作为文档级定义
- v3: 使用全文（去除标题/空行/内联定义行）确保任意改动触发更新

**3. 类型系统扩展（types.ts）**
- v2: `definitionType: 'alias' | 'inline'`
- v3: `definitionType: 'alias' | 'inline' | 'template'` 支持模板类型

**4. 公式工具精简（formulaUtils.ts）**
- v2: 完整注释和详细实现
- v3: 移除 HTML 解码函数，精简代码体积

**5. 定义解析增强（definitionParsing.ts）**
- v3: 修复嵌套词条中的 HTML 转义，添加更安全的事件处理检查

### 关键设计模式

**1. 内容哈希 ID 系统**
```
ID = prefix_hashString(simplifyFilePath + ':' + content)
例: term_a3f2k9j1 (基于文件路径+术语名)
```

**2. 代码块隔离策略**
- 先提取围栏代码块 ````...` `` 和行内代码 `` `code` ``
- 替换为占位符避免内部【】被识别为词条
- 最后恢复代码块内容

**3. 多级索引结构**
```
Map<术语, WikiTerm[]>     // 支持同名多定义
Map<计算值, WikiFormula[]> // 公式按计算值索引
Map<模板, WikiTemplate[]> // 模板按原始别名索引
Set<scope>               // 所有作用域集合
```

### 文件总数统计

| 版本 | 总数 | 核心 | 工具 | 支持 |
|------|------|------|------|------|
| v2   | 22   | 1    | 7    | 14   |
| v3   | 19   | 1    | 6    | 12   |

**核心索引逻辑完全相同**，主要差异在于性能优化、日志增强和类型系统扩展。

