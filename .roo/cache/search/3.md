## CACHE METADATA
- ID: 3
- Created: 2026-02-07T17:26:13.117Z
- Git Commit: fd69457d3226a73a868d66b5a782636c96042e20
- TTL: 168 hours

## QUERY
æ–‡ä»¶å®šä¹‰æ¨¡å¼çš„æ‚¬æµ®å¡ç‰‡å†…å®¹æ˜¾ç¤ºé€»è¾‘åœ¨å“ªé‡Œå®ç°ï¼Ÿ

## SCHEMA
```json
{"type":"object","properties":{"files":{"type":"array","items":{"type":"string"}},"summary":{"type":"string"}}}
```

## RESULT
## æ–‡ä»¶å®šä¹‰æ¨¡å¼æ‚¬æµ®å¡ç‰‡å†…å®¹æ˜¾ç¤ºé€»è¾‘è°ƒæŸ¥æŠ¥å‘Š

### ğŸ“‹ æ¦‚è§ˆ

æ–‡ä»¶å®šä¹‰æ¨¡å¼çš„æ‚¬æµ®å¡ç‰‡ï¼ˆHover Cardï¼‰æ˜¾ç¤ºé€»è¾‘åˆ†å¸ƒåœ¨**å‰ç«¯å’ŒæœåŠ¡ç«¯**ä¸¤ä¸ªéƒ¨åˆ†ï¼š

- **å‰ç«¯**ï¼šVue 3 ç»„ä»¶å±‚è´Ÿè´£UIæ¸²æŸ“å’Œäº¤äº’
- **æœåŠ¡ç«¯**ï¼šNode.js/Bun ç´¢å¼•å™¨è´Ÿè´£æ•°æ®æå–

---

### ğŸ” æ ¸å¿ƒå®ç°æ–‡ä»¶æ¸…å•

**å‰ç«¯ç»„ä»¶ï¼ˆUI äº¤äº’å±‚ï¼‰ï¼š**
1. [src/components/viewer/WikiHoverCard.vue](src/components/viewer/WikiHoverCard.vue:1) - **ä¸»å¡ç‰‡ç»„ä»¶**ï¼Œè´Ÿè´£æ‚¬æµ®å¡ç‰‡çš„æ˜¾ç¤ºã€å®šä½ã€å†…å®¹è§£æ
2. [src/components/viewer/HoverCardLayer.vue](src/components/viewer/HoverCardLayer.vue:1) - æ‚¬æµ®å¡ç‰‡å®¹å™¨å±‚ï¼Œä½¿ç”¨ Teleport åˆ° body
3. [src/composables/useHoverCards.ts](src/composables/useHoverCards.ts:1) - **å¡ç‰‡æ ˆç®¡ç†å™¨**ï¼Œå…¨å±€å•ä¾‹çŠ¶æ€ï¼Œå¤„ç†åµŒå¥—å¡ç‰‡ã€å»¶è¿Ÿå…³é—­ã€ä½ç½®è®¡ç®—
4. [src/components/viewer/WikiTerm.vue](src/components/viewer/WikiTerm.vue:1) - è¯æ¡é“¾æ¥ç»„ä»¶ï¼Œè§¦å‘å¡ç‰‡æ‰“å¼€
5. [src/components/viewer/WikiDefinition.vue](src/components/viewer/WikiDefinition.vue:1) - å®šä¹‰æ¸²æŸ“ç»„ä»¶

**è¯æ¡è§£æä¸æ£€ç´¢ï¼ˆæ•°æ®å±‚ï¼‰ï¼š**
6. [src/utils/term-resolver.ts](src/utils/term-resolver.ts:1) - **è¯æ¡è§£æå¼•æ“**ï¼Œå¤„ç† scope ä¼˜å…ˆçº§æ’åºã€æ¨¡ç³ŠåŒ¹é…å»ºè®®
7. [src/stores/wiki.ts](src/stores/wiki.ts:1) - Pinia å…¨å±€å­˜å‚¨ï¼Œç»´æŠ¤ç´¢å¼•å’Œå½“å‰æ–‡ä»¶ä¸Šä¸‹æ–‡

**Markdown æ¸²æŸ“ï¼ˆè¯­æ³•è½¬æ¢å±‚ï¼‰ï¼š**
8. [src/markdown/rules/wiki-definition.ts](src/markdown/rules/wiki-definition.ts:1) - Markdown è§„åˆ™ï¼šã€è¯æ¡ã€‘ï¼šå®šä¹‰ â†’ \<wiki-definition\> ç»„ä»¶æ ‡ç­¾
9. [src/markdown/index.ts](src/markdown/index.ts:1) - markdown-it å®ä¾‹é…ç½®

**æœåŠ¡ç«¯ç´¢å¼•ï¼ˆæ•°æ®æ„å»ºå±‚ï¼‰ï¼š**
10. [server/indexer/indexer.ts](server/indexer/indexer.ts:1) - WikiIndexer ç±»ï¼Œå…¨é‡/å¢é‡æ„å»ºç´¢å¼•
11. [server/indexer/parser.ts](server/indexer/parser.ts:1) - æ–‡ä»¶è§£æå™¨ï¼Œæå– frontmatterã€æ–‡ä»¶å†…å®šä¹‰ã€å…¬å¼

**ç±»å‹å®šä¹‰ï¼š**
12. [shared/types.ts](shared/types.ts:1) - WikiTermã€WikiFormula ç­‰ç±»å‹å®šä¹‰

---

### ğŸ¯ æ‚¬æµ®å¡ç‰‡å†…å®¹æ˜¾ç¤ºæµç¨‹å›¾

```
ç”¨æˆ·é¼ æ ‡æ‚¬åœã€è¯æ¡ã€‘
    â†“
WikiTerm.vue@mouseenter è§¦å‘
    â†“
useHoverCards.openCard(term, element, parentCardId)
    â”œâ”€ ç”Ÿæˆå”¯ä¸€ IDã€è®¡ç®—å±‚çº§ã€æ£€æŸ¥æœ€å¤§å±‚çº§ï¼ˆMAX_LEVEL=5ï¼‰
    â”œâ”€ å…³é—­åŒçº§å…„å¼Ÿå¡ç‰‡ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    â””â”€ å°†å¡ç‰‡æ¨å…¥å…¨å±€ cards æ•°ç»„
    â†“
HoverCardLayer.vue ç›‘å¬ cards å˜åŒ–
    â””â”€ <TransitionGroup> ä¸ºæ¯ä¸ªå¡ç‰‡æ¸²æŸ“ WikiHoverCard å®ä¾‹
    â†“
WikiHoverCard.vue ç»„ä»¶åŠ è½½
    â”œâ”€ æ¥æ”¶ propsï¼šid, term, triggerRect, level
    â”œâ”€ provide('hoverCardId', id) æ³¨å…¥åˆ°å­ç»„ä»¶
    â”œâ”€ è®¡ç®—å¡ç‰‡ä½ç½®ï¼ˆcalculatePositionï¼‰
    â”‚  â””â”€ å¤„ç†è§†å£è¾¹ç•Œç¿»è½¬ï¼ˆä¸‹æ–¹ç©ºé—´ä¸è¶³ â†’ ä¸Šæ–¹æ˜¾ç¤ºï¼‰
    â””â”€ è§£æè¯æ¡å†…å®¹ï¼š
        â”œâ”€ resolveTerm(term, store.index, currentScope, currentFile)
        â”‚  â”œâ”€ æ£€æŸ¥æ˜¯å¦ç²¾ç¡®åŒ¹é…
        â”‚  â”œâ”€ æŒ‰ scope ä¼˜å…ˆçº§æ’åºå®šä¹‰ï¼š
        â”‚  â”‚  1. æ–‡ä»¶å†…å®šä¹‰ã€è¯æ¡ã€‘ï¼šå®šä¹‰ï¼ˆåŒå½“å‰æ–‡ä»¶ï¼‰
        â”‚  â”‚  2. å½“å‰ scope åŒºåŸŸå®šä¹‰
        â”‚  â”‚  3. å…¨å±€å®šä¹‰ï¼ˆscope=""ï¼‰
        â”‚  â”‚  4. å…¶ä»– scope å®šä¹‰ï¼ˆä»…æ˜¾å¼å¼•ç”¨ã€scope/è¯æ¡ã€‘æ—¶æ˜¾ç¤ºï¼‰
        â”‚  â””â”€ è‹¥æœªåŒ¹é…ï¼šæŸ¥æ‰¾è¿‘ä¼¼åŒ¹é…å»ºè®®ï¼ˆLevenshtein è·ç¦»â‰¤3ï¼‰
        â”‚
        â””â”€ æ¸²æŸ“å†…å®¹ï¼š
           â”œâ”€ è‹¥ç²¾ç¡®åŒ¹é… â†’ æ˜¾ç¤ºå®šä¹‰åˆ—è¡¨ + å…³è”å…¬å¼
           â”‚  â”œâ”€ <HoverCardContent> åŠ¨æ€ç»„ä»¶
           â”‚  â”‚  â””â”€ markdown-it æ¸²æŸ“å®šä¹‰ä¸º HTML
           â”‚  â”‚     â””â”€ åµŒå¥—çš„ã€è¯æ¡ã€‘ä¼šè§¦å‘å­å¡ç‰‡
           â”‚  â”‚
           â”‚  â””â”€ <FormulaContent> åŠ¨æ€ç»„ä»¶
           â”‚     â”œâ”€ æå– [è®¡ç®—å€¼] â†’ WikiFormulaValue
           â”‚     â””â”€ æå– <è®¾è®¡å€¼> â†’ WikiFormulaValue
           â”‚
           â””â”€ è‹¥æœªåŒ¹é… â†’ æ˜¾ç¤ºè¿‘ä¼¼å»ºè®®åˆ—è¡¨

    â†“
é¼ æ ‡ç¦»å¼€å¡ç‰‡
    â””â”€ leaveCard(cardId) è§¦å‘ requestClose(cardId)
       â””â”€ å»¶è¿Ÿ 150ms åå…³é—­ï¼ˆè‹¥æœŸé—´é¼ æ ‡æœªé‡æ–°è¿›å…¥ï¼‰
```

---

### ğŸ”‘ å…³é”®æœºåˆ¶è¯¦è§£

#### 1. **å¡ç‰‡æ ˆç®¡ç†** ([useHoverCards.ts](src/composables/useHoverCards.ts:1))

```typescript
// å…¨å±€çŠ¶æ€
- cards: HoverCardState[] // å½“å‰æ‰“å¼€çš„å¡ç‰‡
- hoveringCardIds: Set<string> // æ­£åœ¨æ‚¬åœçš„å¡ç‰‡
- closeTimers: Map<string, number> // å»¶è¿Ÿå…³é—­è®¡æ—¶å™¨
- MAX_LEVEL = 5 // æœ€å¤§åµŒå¥—å±‚çº§
- CLOSE_DELAY = 150ms // å…³é—­å»¶è¿Ÿ

// æ ¸å¿ƒæ–¹æ³•
- openCard(term, triggerEl, parentCardId) â†’ string|null
  â”œâ”€ æ£€æŸ¥å±‚çº§æ˜¯å¦è¶…è¿‡é™åˆ¶
  â”œâ”€ å…³é—­åŒçº§å…„å¼Ÿå¡ç‰‡
  â””â”€ è¿”å›æ–°å¡ç‰‡ ID
- requestClose(cardId) // è¯·æ±‚å…³é—­ï¼ˆå¯è¢«å–æ¶ˆï¼‰
- cancelClose(cardId) // å–æ¶ˆå…³é—­è¯·æ±‚åŠæ‰€æœ‰ç¥–å…ˆ
- enterCard(cardId) / leaveCard(cardId) // æ ‡è®°é¼ æ ‡çŠ¶æ€
- calculatePosition(triggerRect, cardWidth, cardHeight) â†’ {x, y, placement}
```

#### 2. **è¯æ¡è§£æä¸ä¼˜å…ˆçº§** ([term-resolver.ts](src/utils/term-resolver.ts:1))

```typescript
// è§£ææµç¨‹
resolveTerm(termName, index, currentScope, currentFile)
â”œâ”€ è§£ææ˜¾å¼ scope å‰ç¼€ï¼šã€scope/è¯æ¡ã€‘
â”œâ”€ æŸ¥æ‰¾ç²¾ç¡®åŒ¹é…
â”‚  â””â”€ æŒ‰ä¼˜å…ˆçº§æ’åº sortByPriority()
â”‚     â””â”€ getPriority(def) è¿”å›ä¼˜å…ˆçº§æ•°å€¼ï¼š
â”‚        â”œâ”€ 0: æ–‡ä»¶å†…å®šä¹‰ï¼ˆå½“å‰æ–‡ä»¶ï¼‰
â”‚        â”œâ”€ 1: å½“å‰ scope åŒºåŸŸå®šä¹‰ æˆ– æ˜¾å¼ scope åŒ¹é…
â”‚        â”œâ”€ 2: å…¨å±€å®šä¹‰ï¼ˆscope=""ï¼‰
â”‚        â””â”€ 3: å…¶ä»– scopeï¼ˆä¸ä¸»åŠ¨æ˜¾ç¤ºï¼‰
â”‚
â””â”€ è‹¥æ— åŒ¹é… â†’ findSuggestions() ç”¨ Levenshtein è·ç¦»æŸ¥æ‰¾è¿‘ä¼¼

// Scope è¿‡æ»¤è§„åˆ™
filterByScope(defs, explicitScope, currentScope, currentFile)
â””â”€ æ˜¾å¼å¼•ç”¨ã€scope/è¯æ¡ã€‘ â†’ æ˜¾ç¤ºè¯¥ scope + å…¨å±€
   æ™®é€šå¼•ç”¨ã€è¯æ¡ã€‘ â†’ æ˜¾ç¤ºæ–‡ä»¶å†… + å½“å‰ scope + å…¨å±€ï¼ˆä¸å«å…¶ä»– scopeï¼‰
```

#### 3. **æ–‡ä»¶å†…å®šä¹‰è§£æ** ([parser.ts](server/indexer/parser.ts:1))

æœåŠ¡ç«¯åœ¨ç´¢å¼•æ„å»ºæ—¶è¯†åˆ«ä¸¤ç§å®šä¹‰ï¼š

```
ã€è¯æ¡ã€‘ï¼šå®šä¹‰å†…å®¹  â†’  definitionType: 'inline'
              ï¼ˆå®æ—¶æ˜¾ç¤ºåœ¨å¡ç‰‡ä¸­ï¼‰

frontmatter:
  alias: [NPCåç§°]  â†’  definitionType: 'file'
scope: game2        ï¼ˆä½¿ç”¨æ•´ä¸ªæ–‡ä»¶æ­£æ–‡ä½œä¸ºå®šä¹‰ï¼‰
```

#### 4. **å¡ç‰‡å†…å®¹æ¸²æŸ“** ([WikiHoverCard.vue](src/components/viewer/WikiHoverCard.vue:1))

```typescript
// ä¸¤ä¸ªåŠ¨æ€å­ç»„ä»¶å¤„ç†åµŒå¥—å†…å®¹

<HoverCardContent :content="def.definition" />
â”œâ”€ markdown-it æ¸²æŸ“ä¸º HTML
â”œâ”€ è¯†åˆ«åµŒå¥—çš„ã€è¯æ¡ã€‘ â†’ å˜æˆ WikiTerm ç»„ä»¶
â”œâ”€ è¯†åˆ«ã€è¯æ¡ã€‘ï¼šå®šä¹‰ â†’ å˜æˆ WikiDefinition ç»„ä»¶
â””â”€ è¯†åˆ« %%å…¬å¼%% â†’ å˜æˆ WikiFormula ç»„ä»¶
   â””â”€ åµŒå¥—è¯æ¡æ‚¬åœæ—¶è§¦å‘å­å¡ç‰‡

<FormulaContent :formula="formula.expression" />
â”œâ”€ æå– [xxx] â†’ <WikiFormulaValue type="calc" />
â”œâ”€ æå– <xxx> â†’ <WikiFormulaValue type="design" />
â””â”€ WikiFormulaValue ç‚¹å‡»æ—¶å¯æ‰“å¼€è¯¥å€¼çš„å¡ç‰‡
```

#### 5. **ä½ç½®è‡ªé€‚åº”** ([useHoverCards.ts](src/composables/useHoverCards.ts:70-100))

```typescript
calculatePosition(triggerRect, cardWidth, cardHeight)
â”œâ”€ é»˜è®¤ï¼šä¸‹æ–¹æ˜¾ç¤ºï¼ˆy = triggerRect.bottom + 8pxï¼‰
â”œâ”€ è‹¥ä¸‹æ–¹ç©ºé—´ä¸è¶³ â†’ ç¿»è½¬ä¸Šæ–¹ï¼ˆy = triggerRect.top - cardHeight - 8pxï¼‰
â””â”€ æ°´å¹³è¾¹ç•Œï¼š
   â”œâ”€ å³è¶Šç•Œ â†’ ä»å³è¾¹ç•Œå‘å·¦åç§»
   â””â”€ å·¦è¶Šç•Œ â†’ ä»å·¦è¾¹ç•Œå‘å³åç§»
```

---

### ğŸ“Š æ•°æ®æµå‘

```
åç«¯ç´¢å¼•æ„å»º
    â†“
WikiIndexer.buildIndex() æ‰«ææ‰€æœ‰ .md æ–‡ä»¶
    â”œâ”€ parseFile(content, filePath)
    â”‚  â”œâ”€ æå– frontmatter scope å’Œ alias
    â”‚  â”œâ”€ parseAliasTerms() â†’ æ–‡ä»¶çº§å®šä¹‰
    â”‚  â”œâ”€ parseInlineTerms() â†’ ã€è¯æ¡ã€‘ï¼šå®šä¹‰
    â”‚  â””â”€ parseFormulas() â†’ %%å…¬å¼%%
    â”‚
    â””â”€ æ„å»ºç´¢å¼•æ˜ å°„ï¼š
       â”œâ”€ terms: Map<alias, WikiTerm[]>
       â”œâ”€ formulas: Map<calcValue, WikiFormula[]>
       â””â”€ scopes: Set<scope>

    â†“ï¼ˆé€šè¿‡ /api/indexï¼‰
    
å‰ç«¯ Pinia Store
    â””â”€ useWikiStore.index: WikiIndex
       â”œâ”€ store.index.terms
       â”œâ”€ store.index.formulas
       â””â”€ store.index.scopes

    â†“ï¼ˆæŸ¥è¯¢ï¼‰
    
term-resolver.resolveTerm()
    â””â”€ æ ¹æ®å½“å‰ scope/file æŸ¥è¯¢æœ€ä¼˜åŒ¹é…

    â†“ï¼ˆæ¸²æŸ“ï¼‰
    
WikiHoverCard ç»„ä»¶
    â”œâ”€ æ˜¾ç¤ºå®šä¹‰å†…å®¹
    â”œâ”€ æ˜¾ç¤ºå…³è”å…¬å¼
    â””â”€ æ”¯æŒåµŒå¥—æ‚¬æµ®å¡ç‰‡
```

---

### ğŸ¨ æ ·å¼ä¸äº¤äº’

- **å¡ç‰‡æ ·å¼**ï¼šGitHub-like è®¾è®¡ï¼Œç™½åº•é»‘å­—ï¼Œåœ†è§’é˜´å½±
- **æºä¿¡æ¯é“¾æ¥**ï¼šç‚¹å‡»å¯è·³è½¬åˆ°å®šä¹‰æ¥æºæ–‡ä»¶ï¼ˆå¸¦è¡Œå·å®šä½ï¼‰
- **æœªæ‰¾åˆ°å¤„ç†**ï¼šæ˜¾ç¤º âš ï¸ æç¤º + Levenshtein è·ç¦»æ’åºçš„å»ºè®®
- **åµŒå¥—æŒ‡ç¤º**ï¼šæ–‡ä»¶å†…å®šä¹‰æ˜¾ç¤ºè“è‰² ã€æ–‡ä»¶å†…å®šä¹‰ã€‘ æ ‡ç­¾
- **åŠ¨ç”»**ï¼šè¿›å…¥ 0.15s easeï¼Œç¦»å¼€ 0.1s ease

---

### âœ… æ€»ç»“

**æ‚¬æµ®å¡ç‰‡çš„å®Œæ•´é“¾è·¯ï¼š**

1. **ç”¨æˆ·äº¤äº’** â†’ WikiTerm/WikiFormulaValue çš„ mouseenter
2. **å¡ç‰‡ç®¡ç†** â†’ useHoverCards æ ˆå¼ç®¡ç†ï¼ˆå…¨å±€å•ä¾‹ï¼‰
3. **æ•°æ®æŸ¥è¯¢** â†’ resolveTerm æŒ‰ scope ä¼˜å…ˆçº§æ£€ç´¢
4. **å†…å®¹æ¸²æŸ“** â†’ WikiHoverCard åŠ¨æ€ç¼–è¯‘ HTML + é€’å½’ç»„ä»¶
5. **ä½ç½®è®¡ç®—** â†’ calculatePosition è‡ªé€‚åº”è§†å£è¾¹ç•Œ
6. **äº‹ä»¶ä¼ æ’­** â†’ provide/inject ä¼ é€’ cardIdï¼Œæ”¯æŒåµŒå¥—

æ‰€æœ‰å†…å®¹æœ€ç»ˆéƒ½æ¥è‡ªåç«¯**WikiIndexer**åœ¨å¯åŠ¨æ—¶æ„å»ºçš„å…¨å±€ç´¢å¼•ï¼Œå‰ç«¯é€šè¿‡ WebSocket æ¥æ”¶æ›´æ–°ã€‚
