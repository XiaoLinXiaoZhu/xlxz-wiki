# XLXZ Wiki v3 开发计划与进展总结

## 1. 过去完成的工作

### 1.1 项目架构设计
- ✅ **架构规划**：制定了 `note/architecture.md`，定义了分层架构（Presentation、Application、Plugin、Indexer、Shared）
- ✅ **迁移计划**：制定了 `note/migration-plan.md`，明确了从v2到v3的迁移步骤和验收标准
- ✅ **目录结构**：建立了标准的VuePress 2.x项目结构，包含 `docs/`、`types/`、测试配置等

### 1.2 基础配置与环境
- ✅ **项目初始化**：创建了 `package.json`，配置了pnpm工作区和基础依赖
- ✅ **TypeScript配置**：配置了 `tsconfig.json`，包含路径映射和类型声明
- ✅ **VuePress配置**：创建了 `docs/vuepress/config.ts`，配置了主题、导航和插件
- ✅ **依赖管理**：解决了sass预处理器、git插件、Jest类型声明等依赖问题

### 1.3 核心功能实现
- ✅ **类型系统**：在 `docs/vuepress/types.ts` 中定义了完整的Wiki数据模型
- ✅ **索引器**：实现了 `WikiIndexer` 类，可扫描Markdown文件并构建术语、公式、模板索引
- ✅ **插件系统**：开发了 `wiki-plugin.ts`，集成Markdown渲染管道，支持语法转换
- ✅ **客户端状态**：实现了响应式的 `wikiState`，支持全局数据共享
- ✅ **Vue组件库**：
  - `WikiTerm` - 术语引用组件，支持悬浮卡片
  - `WikiDefinition` - 内联定义组件
  - `WikiFormula` - 公式渲染组件
  - `WikiPageHeader` - 页面元信息显示
  - `WikiHoverCard` - 交互式悬浮卡片
  - `WikiTermContent` - 支持嵌套术语的内容渲染

### 1.4 核心语法支持
- ✅ **术语系统**：
  - 内联定义：`【词条】：定义内容`
  - 术语引用：`【词条】`
  - 作用域支持（frontmatter）
  - 别名机制
  - 嵌套术语引用
- ✅ **公式系统**：
  - 公式块：`%% 公式内容 %%`
  - 计算值高亮：`[计算值]`
  - 设计值高亮：`<设计值>`
- ✅ **模板系统**（基础框架）：
  - 占位符语法：`{占位符}`
  - 模板匹配机制

### 1.5 交互功能
- ✅ **悬浮卡片**：实现了术语和公式的交互式悬浮显示
- ✅ **定义去重**：优先显示内联定义，智能过滤重复内容
- ✅ **文件跳转**：支持点击跳转到定义来源文件
- ✅ **嵌套渲染**：定义内容中的嵌套术语可正确渲染为可交互组件

### 1.6 工具和辅助系统
- ✅ **工具函数库**：
  - `idUtils` - 内容哈希ID生成
  - `markdownUtils` - Markdown解析辅助
  - `formulaUtils` - 公式解析
  - `definitionParsing` - 定义内容解析
  - `html` - HTML编码/解码
  - `hoverGroup` - 悬浮卡片层级管理
- ✅ **样式系统**：完整的CSS样式，与v2视觉一致

## 2. 当前项目状态

### 2.1 功能完成度
| 功能模块 | 状态 | 完成度 |
|---------|------|--------|
| 基础架构 | ✅ 完成 | 100% |
| 术语系统 | ✅ 完成 | 95% |
| 公式系统 | ✅ 完成 | 90% |
| 悬浮卡片 | ✅ 完成 | 90% |
| 模板系统 | ⚠️ 部分完成 | 60% |
| 热更新(HMR) | ❌ 问题待解决 | 30% |

### 2.2 已知问题
1. **热更新问题**：
   - 现象：修改单文件定义后，其他页面的引用不能实时更新
   - 影响：开发体验较差，需要重启服务器
   - 状态：正在调试中，已尝试轮询模式和缓存清理

2. **模板实例化**：
   - 现象：模板占位符替换功能未完全实现
   - 示例：`【{小明}向{小红}释放技能】` 无法根据模板自动生成定义
   - 状态：基础框架已实现，需要完善实例化逻辑

3. **相关公式显示**：
   - 现象：悬浮卡片中的"相关公式"功能未实现
   - 状态：数据结构已支持，需要完善UI逻辑

### 2.3 技术债务
- 部分组件缺少单元测试
- HMR机制需要进一步优化
- 某些边界情况的错误处理不够完善

## 3. 未来规划

### 3.1 短期目标（优先级：高）

#### 3.1.1 解决HMR问题
- **目标**：实现文件修改后的实时更新
- **方案**：
  1. 深入调研VuePress 2.x的HMR机制
  2. 考虑使用VuePress内置的页面监听事件
  3. 优化temp文件的变更检测机制
- **预期时间**：1-2天

#### 3.1.2 完善模板系统
- **目标**：实现完整的模板实例化功能
- **内容**：
  - 完善 `templateMatch.ts` 中的实例化逻辑
  - 在 `WikiTerm` 组件中集成模板匹配
  - 支持动态生成带参数的定义内容
- **预期时间**：2-3天

#### 3.1.3 实现相关公式显示
- **目标**：在悬浮卡片中显示相关公式
- **内容**：
  - 完善 `WikiHoverCard` 组件的公式显示逻辑
  - 实现基于当前页面的公式关联算法
- **预期时间**：1天

### 3.2 中期目标（优先级：中）

#### 3.2.1 性能优化
- **索引构建性能**：优化大型项目的索引构建速度
- **组件渲染性能**：优化悬浮卡片的显示性能
- **内存使用**：优化客户端内存占用

#### 3.2.2 开发者体验
- **错误提示**：完善语法错误的提示机制
- **调试工具**：开发专用的调试面板
- **文档完善**：编写详细的开发和使用文档

#### 3.2.3 扩展功能
- **搜索功能**：实现全局术语和公式搜索
- **导出功能**：支持导出为静态HTML或PDF
- **主题系统**：支持自定义主题和样式

### 3.3 长期目标（优先级：低）

#### 3.3.1 生态系统
- **插件体系**：开发第三方插件API
- **编辑器支持**：VSCode扩展，提供语法高亮和自动补全
- **CI/CD集成**：自动化构建和部署工具

#### 3.3.2 高级功能
- **版本控制**：术语和定义的版本管理
- **协作功能**：多人协作编辑支持
- **国际化**：多语言界面支持

## 4. 开发建议

### 4.1 开发优先级
1. **紧急**：修复HMR问题（影响开发效率）
2. **重要**：完善模板系统（核心功能缺失）
3. **普通**：相关公式显示（用户体验改进）
4. **可延后**：性能优化和扩展功能

### 4.2 质量保证
- 在实现新功能前，应先为现有核心组件编写单元测试
- 每个新功能都应该有对应的示例页面
- 重要变更需要更新相关文档

### 4.3 技术选型建议
- 保持当前的技术栈稳定（VuePress 2.x + Vue 3 + TypeScript）
- 优先使用VuePress原生API，避免过度依赖第三方库
- 注重代码的模块化和可测试性

---

**更新时间**：2024年12月19日  
**文档版本**：v1.0  
**负责人**：开发团队
