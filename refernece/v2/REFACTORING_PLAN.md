# XLXZ Wiki v2 代码重构计划

## 📋 项目概述
基于对XLXZ Wiki v2项目的全面静态分析，识别出重复定义、废弃代码和未使用函数等问题，制定此重构计划。

## 🔍 问题总结

### 已识别的问题
1. **重复定义**：
   - `toggleFenceIfNeeded` 在 `indexer.ts` 中定义两次
   - `extractCalculatedValues` 和 `extractDesignValues` 在 `processor.ts` 和 `indexer.ts` 中重复

2. **废弃代码**：
   - `WikiTerm.vue` 中的注释样式代码（第74-87行）
   - 大量调试相关的注释代码

3. **未使用代码**：
   - `zIndex.ts` 中的 `peekCurrentZ()` 函数

## 🎯 重构目标

### 短期目标（1-2天）
- [ ] 创建统一的工具函数模块
- [ ] 消除重复定义
- [ ] 清理废弃代码

### 中期目标（1周）
- [ ] 统一代码风格
- [ ] 建立代码规范
- [ ] 添加基础测试

### 长期目标（1个月）
- [ ] 完善测试覆盖
- [ ] 性能优化
- [ ] 文档完善

## 📁 文件结构优化

### 新增文件
```
docs/.vuepress/utils/
├── formulaUtils.ts      # 公式处理工具函数
├── markdownUtils.ts     # Markdown处理工具函数
└── index.ts            # 工具函数统一导出
```

### 修改文件
```
docs/.vuepress/
├── indexer.ts          # 移除重复定义，使用新工具模块
├── processor.ts        # 移除重复定义，使用新工具模块
├── components/
│   └── WikiTerm.vue    # 清理注释代码
└── utils/
    └── zIndex.ts       # 移除未使用函数
```

## 🔧 具体实施步骤

### 第一阶段：创建工具模块（已完成）
- ✅ 创建 `formulaUtils.ts` - 统一公式处理功能
- ✅ 创建 `markdownUtils.ts` - 统一Markdown处理功能

### 第二阶段：消除重复定义
1. **修改 `indexer.ts`**：
   - 移除第88-99行的 `toggleFenceIfNeeded` 定义
   - 移除第286-309行的 `extractCalculatedValues` 和 `extractDesignValues`
   - 导入并使用新的工具模块

2. **修改 `processor.ts`**：
   - 移除第154-177行的 `extractCalculatedValues` 和 `extractDesignValues`
   - 导入并使用新的工具模块

### 第三阶段：清理废弃代码
1. **清理 `WikiTerm.vue`**：
   - 删除第74-87行的注释样式代码
   - 删除第367-387行的注释工具函数

2. **清理 `zIndex.ts`**：
   - 删除未使用的 `peekCurrentZ()` 函数

### 第四阶段：统一导入
创建 `utils/index.ts` 统一导出所有工具函数：
```typescript
export * from './formulaUtils'
export * from './markdownUtils'
export * from './debug'
export * from './definitionParsing'
```

## 🧪 测试计划

### 单元测试
- 测试公式提取功能
- 测试Markdown处理功能
- 测试代码块识别功能

### 集成测试
- 验证词条解析功能
- 验证公式高亮功能
- 验证模板匹配功能

## 📊 风险评估

### 低风险
- 工具函数提取 - 纯函数，无副作用
- 注释代码清理 - 不影响功能

### 中风险
- 重复定义替换 - 需要确保功能一致性
- 导入路径修改 - 需要验证所有引用

### 缓解措施
- 保留原文件备份
- 分步骤实施，每步验证
- 添加详细测试用例

## 🚀 实施时间表

| 阶段 | 任务 | 预计时间 | 状态 |
|------|------|----------|------|
| 1 | 创建工具模块 | 1小时 | ✅ 完成 |
| 2 | 消除重复定义 | 2小时 | 待开始 |
| 3 | 清理废弃代码 | 1小时 | 待开始 |
| 4 | 统一导入 | 30分钟 | 待开始 |
| 5 | 测试验证 | 2小时 | 待开始 |
| 6 | 文档更新 | 1小时 | 待开始 |

## 📋 检查清单

### 代码质量
- [ ] 所有重复定义已消除
- [ ] 所有废弃代码已清理
- [ ] 工具函数有完整测试覆盖
- [ ] 代码风格统一
- [ ] 导入路径清晰

### 功能验证
- [ ] 词条解析功能正常
- [ ] 公式处理功能正常
- [ ] 悬浮卡片功能正常
- [ ] 模板匹配功能正常
- [ ] 作用域过滤功能正常

### 文档
- [ ] 工具函数文档完整
- [ ] 使用示例清晰
- [ ] 重构变更记录

## 🔄 后续维护

### 代码规范
- 新增功能前先检查是否已存在
- 定期运行代码质量检查
- 建立代码审查流程

### 监控指标
- 重复代码比例 < 5%
- 未使用代码比例 < 3%
- 测试覆盖率 > 80%

---

**计划制定完成，准备开始实施重构工作。**